apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: dawarich
    app.kubernetes.io/version: latest
  name: dawarich
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: dawarich
  template:
    metadata:
      labels:
        app.kubernetes.io/name: dawarich
        app.kubernetes.io/version: latest
    spec:
      containers:
      - args:
        - bin/rails
        - server
        - '-p'
        - '3000'
        - '-b'
        - '::'
        command:
        - web-entrypoint.sh
        env:
        - name: RAILS_ENV
          value: development
        - name: REDIS_URL
          value: redis://redis.redis.svc.cluster.local:6379
        - name: DATABASE_HOST
          value: postgres-postgresql.postgres.svc.cluster.local
        - name: DATABASE_PORT
          value: '5432'
        - name: DATABASE_USERNAME
          value: postgres
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: postgres-creds-secret
        - name: DATABASE_NAME
          value: dawarich_development
        - name: MIN_MINUTES_SPENT_IN_CITY
          value: '60'
        - name: APPLICATION_HOSTS
          value: dawarich.cluster.netbird.selfhosted
        - name: TIME_ZONE
          value: Europe/Vienna
        - name: APPLICATION_PROTOCOL
          value: http
        - name: PROMETHEUS_EXPORTER_ENABLED
          value: 'false'
        - name: PROMETHEUS_EXPORTER_HOST
          value: '0.0.0.0'
        - name: PROMETHEUS_EXPORTER_PORT
          value: '9394'
        - name: SELF_HOSTED
          value: 'true'
        - name: STORE_GEODATA
          value: 'true'
        image: freikin/dawarich:latest
        name: dawarich
        ports:
        - containerPort: 3000
          name: dawarich
        volumeMounts:
        - mountPath: /var/app/public
          name: public-dawarich-volume
        - mountPath: /var/app/tmp/imports/watched
          name: watched-dawarich-volume
        - mountPath: /var/app/storage
          name: storage-dawarich-volume
      - command:
        - sidekiq-entrypoint.sh
        env:
        - name: RAILS_ENV
          value: development
        - name: REDIS_URL
          value: redis://redis.redis.svc.cluster.local:6379
        - name: DATABASE_HOST
          value: postgres-postgresql.postgres.svc.cluster.local
        - name: DATABASE_PORT
          value: '5432'
        - name: DATABASE_USERNAME
          value: postgres
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: postgres-creds-secret
        - name: DATABASE_NAME
          value: dawarich_development
        - name: APPLICATION_HOSTS
          value: dawarich.cluster.netbird.selfhosted
        - name: BACKGROUND_PROCESSING_CONCURRENCY
          value: '10'
        - name: APPLICATION_PROTOCOL
          value: http
        - name: PROMETHEUS_EXPORTER_ENABLED
          value: 'false'
        - name: PROMETHEUS_EXPORTER_HOST
          value: dawarich_app
        - name: PROMETHEUS_EXPORTER_PORT
          value: '9394'
        - name: SELF_HOSTED
          value: 'true'
        - name: STORE_GEODATA
          value: 'true'
        image: freikin/dawarich:latest
        name: dawarich-sidekiq
        ports:
        - containerPort: 3000
          name: dawarich
        volumeMounts:
        - mountPath: /var/app/public
          name: public-dawarich-volume
        - mountPath: /var/app/tmp/imports/watched
          name: watched-dawarich-volume
        - mountPath: /var/app/storage
          name: storage-dawarich-volume
      volumes:
      - name: public-dawarich-volume
        persistentVolumeClaim:
          claimName: public-dawarich-pvc
      - name: watched-dawarich-volume
        persistentVolumeClaim:
          claimName: watched-dawarich-pvc
      - name: storage-dawarich-volume
        persistentVolumeClaim:
          claimName: storage-dawarich-pvc
