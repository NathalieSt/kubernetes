apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
spec:
  releaseName: forgejo
  chartRef:
    kind: OCIRepository
    name: forgejo
  interval: '24h'
  install:
    remediation:
      retries: 3
  timeout: '5m'
  valuesFrom:
  - kind: Secret
    name: postgres-creds-secret
    valuesKey: password
    targetPath: gitea.config.database.PASSWD
    optional: false
  values:
    gitea:
      config:
        database:
          DB_TYPE: postgres
          HOST: postgres.postgres.svc.cluster.local:5432
          NAME: forgejo
          USER: postgres
      queue:
        TYPE: redis
        CONN_STR: valkey://valkey.valkey.svc.cluster.local:6379/0?
      cache:
        ADAPTER: redis
        HOST: valkey://valkey.valkey.svc.cluster.local:6379/1
      session:
        PROVIDER: redis
        PROVIDER_CONFIG: valkey://valkey.valkey.svc.cluster.local:6379/2
    persistence:
      enabled: true
      storageClass: nfs-remote
    extraContainers:
    - name: netbird-agent
      image: netbirdio/netbird:latest
      env:
      - name: NB_SETUP_KEY
        valueFrom:
          secretKeyRef:
            name: netbird-setup-key-vault-secret
            key: netbird-setup-key-vault-secret
      - name: NB_HOSTNAME
        value: code
      - name: NB_MANAGEMENT_URL
        value: https://netbird.nathalie-stiefsohn.eu
      resources:
        requests:
          cpu: '50m'
          memory: '64Mi'
        limits:
          cpu: '100m'
          memory: '128Mi'
      securityContext:
        privileged: true
