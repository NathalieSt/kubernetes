apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
spec:
  interval: 24h
  chartRef:
    kind: OCIRepository
    name: forgejo-repo
  timeout: 10m
  releaseName: forgejo
  install:
    remediation:
      retries: 3
  values:
    gitea:
      admin:
        username: Nathi
      cache:
        ADAPTER: redis
        HOST: valkey://valkey.valkey.svc.cluster.local:6379/1
      config:
        database:
          DB_TYPE: postgres
          HOST: postgres-rw.postgres.svc.cluster.local:5432
          NAME: forgejo
      podAnnotations:
        proxy.istio.io/config: "{'holdApplicationUntilProxyStarts': true}"
      queue:
        CONN_STR: valkey://valkey.valkey.svc.cluster.local:6379/0?
        TYPE: redis
      session:
        PROVIDER: redis
        PROVIDER_CONFIG: valkey://valkey.valkey.svc.cluster.local:6379/2
    persistence:
      enabled: true
      storageClass: nfs-remote
  valuesFrom:
  - kind: Secret
    name: postgres-creds-secret
    valuesKey: username
    targetPath: gitea.config.database.USER
  - kind: Secret
    name: postgres-creds-secret
    valuesKey: password
    targetPath: gitea.config.database.PASSWD
