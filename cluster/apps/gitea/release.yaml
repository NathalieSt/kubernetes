apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitea
  namespace: gitea
spec:
  releaseName: gitea
  chart:
    spec:
      chart: gitea
      sourceRef:
        kind: HelmRepository
        name: gitea
  interval: 50m
  install:
    remediation:
      retries: 3
  values:
    actions:
      enabled: true
      provisioning:
        enabled: true
    serviceAccount:
      name: gitea-tailscale
    extraContainers:
      - name: tailscale-sidecar
        image: ghcr.io/tailscale/tailscale:latest
        hostname: gitea
        env:
          - name: TS_SERVE_CONFIG
            value: |-
              {
                "TCP": {
                  "443": {
                    "HTTPS": true
                  }
                },
                "Web": {
                  "${TS_CERT_DOMAIN}:443": {
                    "Handlers": {
                      "/": {
                        "Proxy": "http://127.0.0.1:3000"
                      }
                    }
                  }
                },
                "AllowFunnel": {
                  "${TS_CERT_DOMAIN}:443": false,
                }
              }
          - name: TS_KUBE_SECRET
            value: tailscale-auth
          - name: TS_AUTHKEY
            valueFrom:
              secretKeyRef:
                name: tailscale-auth
                key: TS_AUTHKEY
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
