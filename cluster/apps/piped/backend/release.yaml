---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: piped-backend
spec:
  interval: 24h
  chartRef:
    kind: HelmChart
    name: piped-backend-chart
  timeout: 10m
  releaseName: piped-backend
  install:
    remediation:
      retries: 3
  values:
    backend:
      additionalContainers:
        netbird-agent:
          image: netbirdio/netbird:latest
          name: netbird-agent
          env:
          - name: NB_SETUP_KEY
            valueFrom:
              secretKeyRef:
                key: setup-key
                name: netbird-setup-key-vault-secret
          - name: NB_MANAGEMENT_URL
            value: https://netbird.nathalie-stiefsohn.eu
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          securityContext:
            privileged: true
      config:
        API_URL: https://piped-backend.cloud.nathalie-stiefsohn.eu
        FRONTEND_URL: https://piped.cloud.nathalie-stiefsohn.eu
        PROXY_PART: https://piped-ytproxy.cloud.nathalie-stiefsohn.eu
        database:
          connection_url: jdbc:postgresql://postgres-rw.postgres.svc.cluster.local:5432/piped
          dialect: org.hibernate.dialect.PostgreSQLDialect
          driver_class: org.postgresql.Driver
      service:
        main:
          enabled: "false"
    controller:
      enabled: true
    frontend:
      enabled: false
    ingress:
      backend:
        enabled: true
      main:
        enabled: true
      ytproxy:
        enabled: true
    ytproxy:
      enabled: false
  valuesFrom:
  - kind: Secret
    name: postgres-creds-secret
    valuesKey: username
    targetPath: backend.config.database.username
  - kind: Secret
    name: postgres-creds-secret
    valuesKey: password
    targetPath: backend.config.database.password
