apiVersion: v1
data:
  default.conf: "                # WebSocket upgrade mapping\n                map $http_upgrade $connection_upgrade {\n                    default upgrade;\n                    '' close;\n                }\n                \n                upstream authentik {\n                    server authentik.authentik.svc.cluster.local:9000;\n                }\n\n                # HTTP server - redirect to HTTPS\n                server {\n                    listen 80;\n                    server_name authentik.netbird.selfhosted;\n                    return 301 https://$server_name$request_uri;\n                }\n\n                # HTTPS server\n                server {\n                    listen 443 ssl;\n                    http2 on;\n                    server_name authentik.netbird.selfhosted;\n                    \n                    ssl_certificate /etc/nginx/ssl/tls.crt;\n                    ssl_certificate_key /etc/nginx/ssl/tls.key;\n                    \n                    # Security headers (relaxed for Authentik)\n                    add_header Strict-Transport-Security \"max-age=63072000\" always;\n                    add_header X-Content-Type-Options nosniff;\n                    add_header X-XSS-Protection \"1; mode=block\";\n                    \n                    # Increase client body size for file uploads\n                    client_max_body_size 100M;\n                    \n                    # Timeout settings for long-running requests\n                    proxy_connect_timeout 600s;\n                    proxy_send_timeout 600s;\n                    proxy_read_timeout 600s;\n                    \n                    location / {\n                        proxy_pass http://authentik;\n                        \n                        # Essential headers for Authentik\n                        proxy_set_header Host $http_host;\n                        proxy_set_header X-Real-IP $remote_addr;\n                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n                        proxy_set_header X-Forwarded-Proto $scheme;\n                        proxy_set_header X-Forwarded-Host $http_host;\n                        proxy_set_header X-Forwarded-Port $server_port;\n                        \n                        # Additional headers for proper authentication flow\n                        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;\n                        proxy_set_header X-Forwarded-Uri $request_uri;\n                        \n                        # WebSocket support\n                        proxy_http_version 1.1;\n                        proxy_set_header Upgrade $http_upgrade;\n                        proxy_set_header Connection $connection_upgrade;\n                        \n                        # Buffering settings for better performance\n                        proxy_buffering off;\n                        proxy_request_buffering off;\n                        \n                        # CORS headers for API requests\n                        add_header Access-Control-Allow-Origin $http_origin always;\n                        add_header Access-Control-Allow-Methods \"GET, POST, PUT, DELETE, OPTIONS, PATCH\" always;\n                        add_header Access-Control-Allow-Headers \"Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, Keep-Alive, X-Requested-With, If-Modified-Since, X-CSRF-Token\" always;\n                        add_header Access-Control-Allow-Credentials true always;\n                        \n                        # Handle preflight requests\n                        if ($request_method = 'OPTIONS') {\n                            add_header Access-Control-Allow-Origin $http_origin always;\n                            add_header Access-Control-Allow-Methods \"GET, POST, PUT, DELETE, OPTIONS, PATCH\" always;\n                            add_header Access-Control-Allow-Headers \"Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, Keep-Alive, X-Requested-With, If-Modified-Since, X-CSRF-Token\" always;\n                            add_header Access-Control-Allow-Credentials true always;\n                            add_header Access-Control-Max-Age 86400;\n                            add_header Content-Length 0;\n                            add_header Content-Type text/plain;\n                            return 204;\n                        }\n                    }\n                }\n            \n            "
kind: ConfigMap
metadata:
  name: nginx-config
