---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: vector
spec:
  interval: 24h
  chartRef:
    kind: HelmChart
    name: vector-chart
  timeout: 10m
  releaseName: vector
  install:
    remediation:
      retries: 3
  values:
    logLevel: debug
    customConfig:
      api:
        enabled: true
        address: 127.0.0.1:8686
        playground: true
      data_dir: /vector-data-dir
      sinks:
        es_cluster:
          api_version: auto
          auth:
            strategy: basic
          bulk:
            action: create
            index: vector-%Y-%m-%d
          compression: none
          doc_type: _doc
          endpoints:
            - http://elasticsearch-es-internal-http.elastic-stack.svc.cluster.local:9200
          inputs:
            - k8s_in
          mode: bulk
          type: elasticsearch
      sources:
        k8s_in:
          auto_partial_merge: true
          delay_deletion_ms: 60000
          fingerprint_lines: 1
          glob_minimum_cooldown_ms: 60000
          ignore_older_secs: 600
          insert_namespace_fields: true
          self_node_name: ${VECTOR_SELF_NODE_NAME}
          timezone: local
          type: kubernetes_logs
    role: Agent
    service:
      enabled: false
  valuesFrom:
    - kind: Secret
      name: elastic-search-vector-secret
      valuesKey: password
      targetPath: customConfig.sinks.es_cluster.auth.password
    - kind: Secret
      name: elastic-search-vector-secret
      valuesKey: username
      targetPath: customConfig.sinks.es_cluster.auth.user
