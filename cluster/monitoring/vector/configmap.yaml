---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector
data:
  agent.yaml: |
    api:
      enabled: false
    data_dir: /vector-data-dir
    # -------------------------------------------------
    # SOURCE - Kubernetes pod/container logs
    # -------------------------------------------------
    sources:
      k8s_in:
        auto_partial_merge: true
        delay_deletion_ms: 60000
        fingerprint_lines: 1
        glob_minimum_cooldown_ms: 60000
        ignore_older_secs: 600
        insert_namespace_fields: true
        self_node_name: ${VECTOR_SELF_NODE_NAME}
        timezone: local
        type: kubernetes_logs
    # -------------------------------------------------
    # TRANSFORMS - filter / sample / prune
    # -------------------------------------------------
    transforms:
      drop_noisy_logs:
        type: filter
        inputs:
          - k8s_in
        condition: |
          !(.kubernetes.container_name == "kube-proxy" || .kubernetes.container_name == "kube-apiserver" || .kubernetes.container_name == "coredns" && contains!(.message, "health"))
    
      drop_debug_logs:
        type: filter
        inputs:
          - drop_noisy_logs
        condition: |
          .status_code != 200 && !includes(["info", "debug"], .severity)
    
      remove_k8s_noise:
        type: remap
        inputs:
          - drop_debug_logs
        source: |
          # Keep only essential Kubernetes metadata
          del(.kubernetes.pod_uid)
          del(.kubernetes.container_id)
          del(.kubernetes.container_image_id)
          del(.kubernetes.node_labels)
          del(.kubernetes.pod_labels)
          del(.kubernetes.namespace_labels)
          del(.kubernetes.annotations)
    
      normalize_logs:
        type: remap
        inputs:
          - remove_k8s_noise
        source: |
          # Rename message to short key
          .msg = .message
          del(.message)
    
          # Normalize level
          if exists(.level) {
            .lvl = downcase!(.level)
            del(.level)
          }
    
          # Remove empty fields
          if is_null(.msg) { del(.msg) }
    
      truncate_messages:
        type: remap
        inputs:
          - normalize_logs
        source: |
          max_len = 2048
    
          msg = to_string(.msg) ?? null
          if msg != null && length!(msg) > max_len {
            .msg = truncate!(msg, max_len, "...Truncated")
          }
    
    # -------------------------------------------------
    # SINK - Elasticsearch
    # -------------------------------------------------
    sinks:
      es_cluster:
        api_version: auto
        auth:
          strategy: basic
          user: ${ELASTIC_USER}
          password: ${ELASTIC_PASSWORD}
        bulk:
          action: create
          index: vector-%Y-%m-%d
        compression: gzip
        doc_type: _doc
        endpoints:
          - http://elasticsearch-es-internal-http.elastic-stack.svc.cluster.local:9200
        inputs:
          - truncate_messages
        mode: bulk
        type: elasticsearch
