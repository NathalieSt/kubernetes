---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector
data:
  agent.yaml: |
    api:
      enabled: false
    data_dir: /vector-data-dir
    # -------------------------------------------------
    # SOURCE - Kubernetes pod/container logs
    # -------------------------------------------------
    sources:
      k8s_in:
        auto_partial_merge: true
        delay_deletion_ms: 60000
        fingerprint_lines: 1
        glob_minimum_cooldown_ms: 60000
        ignore_older_secs: 600
        insert_namespace_fields: true
        self_node_name: ${VECTOR_SELF_NODE_NAME}
        timezone: local
        type: kubernetes_logs
    # -------------------------------------------------
    # TRANSFORMS - filter / sample / prune
    # -------------------------------------------------
    transforms:
      # -------------------------------------------------
      # Drop DEBUG-level entries (still a filter)
      # -------------------------------------------------
      drop_debug:
        type: filter
        inputs:
          - k8s_in
        condition: '.level != "debug"'
    
      # -------------------------------------------------
      # Filter the health-check / success logs you want to sample
      # -------------------------------------------------
      filter_health:
        type: filter
        inputs:
          - drop_debug
        # Adjust the field name to whatever your pods emit.
        # Many containers use `status`, `http_status`, or `code`.
        condition: ".status == 200 or .http_status == 200"
    
      # -------------------------------------------------
      # Sample the *already-filtered* health logs
      # -------------------------------------------------
      sample_health:
        type: sample
        inputs:
          - filter_health
        # Keep roughly 5% of the matching events (tweak as needed)
        rate: 0.05
    
      # -------------------------------------------------
      # Prune large / unused fields
      # -------------------------------------------------
      prune_fields:
        type: remap
        inputs:
          - sample_health
        source: |
          . = del(.["stacktrace"])
          . = del(.["message_raw"])
          . = del(.["container_image"])
          . = del(.["pod_annotations"])
          . = del(.["kubernetes"]["labels"]["some-noisy-label"])
    
      # -------------------------------------------------
      # Normalise timestamps to UTC
      # -------------------------------------------------
      normalize_ts:
        type: remap
        inputs:
          - prune_fields
        source: |
          .["@timestamp"] = to_timestamp!(.["@timestamp"]).to_rfc3339()
    
    # -------------------------------------------------
    # SINK - Elasticsearch
    # -------------------------------------------------
    sinks:
      es_cluster:
        api_version: auto
        auth:
          strategy: basic
          user: ${ELASTIC_USER}
          password: ${ELASTIC_PASSWORD}
        bulk:
          action: create
          index: vector-%Y-%m-%d
        compression: gzip
        doc_type: _doc
        endpoints:
          - http://elasticsearch-es-internal-http.elastic-stack.svc.cluster.local:9200
        inputs:
          - normalize_ts
        mode: bulk
        type: elasticsearch
